---
title: "Expansion: The Borg Brewery"
author: "James Jarding, Nikhil Gupta, Max Moro"
date: "September 29, 2018"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DT)
library(tidyverse)
library(ggplot2)
library(htmltools)
library(knitr)
library(scales)

# For maps
library(maps)
library(geojsonio)
library(leaflet)
library(plotly)
```

# Expansion: The Borg Brewery

We are here because of our love for Star Wars and beer.  Who would have ever imagined we would get tired of the typical draft beer and decide to brew our on own beer.  It started out as a small group competition that resulted in us picking a few brews, purchasing a building to meet and finally a full blown brewery that attracks not just Star Wars fans but fans of science fiction in general.  We now have 10 different draft beers and 2 seasonal beers.  

Last month, the talk of selling our brew to other breweries caught fire.  We sat around brainstorming and really getting to know where.  Way too many ideas were thrown on the table and most were not based on any research.  In an attempt to further the discussion, we (James, Max and Nikhil) decided to do some research hoping to channel our discussion around factual data to best of our knowledge.  The data we have collected contains a sample of brewries by city/state and the desired taste by state.  This will help to narrow our focus to areas where beer is seen as a necessity and a strong opinion as to the desired taste.  

# Breweries by State

First, lets take a look at the data we have.  

```{r}
beers = read.csv('data/Beers.csv')
breweries = read.csv('data/Breweries.csv')

str(beers)
str(breweries)

# Both dataframes have column called 'Name'.
# In beers, it refers to the name of the beer
# In breweries, it refers to the name of the breweries.
# Let's rename for clarity, especially after merging.

names(beers)[names(beers) %in% 'Name'] <- 'Beer'
names(breweries)[names(breweries) %in% 'Name'] <- 'Brewery'

str(beers)
str(breweries)
```


## How many breweries are present in each state?


```{r}
# Option 1
# breweriesState = breweries %>%
#   group_by(State) %>%
#   summarise(Breweries = n()) %>%
#   ungroup()

breweriesState = breweries %>% count(State) # Option 2
DT::datatable(breweriesState,rownames = F)
```

Where can we focus our research?
- Top 10 States: CO, CA, MI, OR, TX, PA, MA, WA, IN, WI

Where should we avoid making strong assumptions?
- Bottom 10 States: DC, ND, SD, WV, AR, DE, MS, NV, AL, KS


```{r Not Working Yet, eval=FALSE, include=FALSE}
# plot_usmap(data = breweriesState, values = "Breweries", lines = "red") +
#   scale_fill_continuous(name = "Breweries", label = scales::comma) +
#   theme(legend.position = "right")

```

```{r Leaflet Map}
str(breweriesState)

# https://rstudio.github.io/leaflet/map_widget.html
mapStates = map("state", fill = TRUE, plot = FALSE)
str(mapStates)
mapStates$names 
# This will not work becasue of the way states are defined; would need major rework
# example state names are "Arizona", but we have "AZ" in out dataframe. 
# Also, some states are named "michigan:north", "michigan:south", etc.

# Anyway adding some examples here in case we want to explore this further
leaflet(data = mapStates) %>% addTiles() %>%
  addPolygons(fillColor = topo.colors(10, alpha = NULL), stroke = FALSE)

m = leaflet() %>% addTiles()
df = data.frame(
  lat = rnorm(100),
  lng = rnorm(100),
  size = runif(100, 5, 20),
  color = sample(colors(), 100)
)
m = leaflet(df) %>% addTiles()
m %>% addCircleMarkers(radius = ~size, color = ~color, fill = FALSE)
m %>% addCircleMarkers(radius = runif(100, 4, 10), color = c('red'))

```

```{r Leaflet another option}
states <- geojsonio::geojson_read("http://eric.clst.org/assets/wiki/uploads/Stuff/gz_2010_us_outline_20m.json", what = "sp")
class(states)
names(states)
#head(states)

# Not sure yet if I need to get a special token for this.
# Below code is only plotting the boundary of US, not the states
# We can also try with other JSON files. They are available in the same link path as above.
m <- leaflet(states) %>%
  setView(-96, 37.8, 4) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) 

m %>% addPolygons()
```


```{r Plotly Map Example on Website not working}
# https://plot.ly/r/choropleth-maps/
df <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")
df$hover <- with(df, paste(state, '<br>', "Beef", beef, "Dairy", dairy, "<br>",
                           "Fruits", total.fruits, "Veggies", total.veggies,
                           "<br>", "Wheat", wheat, "Corn", corn))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

p <- plot_geo(df, locationmode = 'USA-states') %>%
  add_trace(
    z = ~total.exports, text = ~hover, locations = ~code,
    color = ~total.exports, colors = 'Purples'
  ) %>%
  colorbar(title = "Millions USD") %>%
  layout(
    title = '2011 US Agriculture Exports by State<br>(Hover for breakdown)',
    geo = g
  )
p

```


# Question 2

Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file

```{r}
data = merge(beers,breweries,by.x='Brewery_id',by.y='Brew_ID',all=T) 

h4('First 6 Observations')
DT::datatable(head(data,6),rownames = F)

h4('Last 6 Observations')
DT::datatable(tail(data,6),rownames = F)
```


# Question 3

Report the number of NA's in each column

```{r}
countNA = sapply(data,function(x){sum(is.na(x))})
kable(countNA,col.names='Count of NA')
```

# Question 4

Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare

```{r fig.height=7, warning=FALSE}

summary = data %>%
  group_by(State) %>%
  summarise(ABVMedian = median(ABV,na.rm=T)
            ,IBUMedian = median(IBU,na.rm=T)
            ) %>%
  ungroup() 

summary(summary)

# Question: Why do we need ungroup()? The code below works just fine without ungroup()
summary = data %>%
  group_by(State) %>%
  summarise(ABVMedian = median(ABV,na.rm=T) 
            ,IBUMedian = median(IBU,na.rm=T)
            ) 
  
summary(summary)

# There is an NA value. Which one is it?
summary[rowSums(is.na(summary)) > 0,]

# SD has NA values for IBUMedian; need to remove before plotting
# Why does SD have NA values even though we removed NA values when we calculated median?
# Reason: na.rm will remove NA values before applying median function. However, if a state has all NA values 
# for a field (for example SD has all NA value for IBU), the summarize will add a NA value for that State

trim <- function (x) gsub("^\\s+|\\s+$", "", x)
data$State <- trim(data$State)
data[data$State == 'SD', ]

ggplot(data=filter(summary,!is.na(ABVMedian))
       ,aes(x=fct_reorder(State,ABVMedian,desc=T)
                        ,y=ABVMedian)) +
  geom_col() +
  xlab("State") +
  ylab("Median Alcohol Content") +
  scale_y_continuous(labels=percent)+
  coord_flip()

ggplot(data=filter(summary,!is.na(IBUMedian))
       ,aes(x=fct_reorder(State,IBUMedian,desc=T)
                        ,y=IBUMedian)) +
  geom_col() +
  xlab("State") +
  ylab("Median International Bitterness Unit") +
  coord_flip()

```


# Question 5

Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?

```{r}
message("The State with the maximum alcoholic (ABV) beer is:"
        ,arrange(data,desc(ABV))$State[1]
        )

message("The State with the most bitter (IBU) beer is:"
        ,arrange(data,desc(IBU))$State[1]
        )
```

# Question 6

Summary statistics for the ABV variable:

```{r}
summary(data$ABV)
```

# Question 7

Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.

```{r warning=FALSE}
ggplot(data=data,aes(x=IBU,y=ABV))+
  geom_point() +
  geom_smooth(method='lm') +
  scale_y_continuous(labels=percent)

model=lm(data=data,formula=ABV~IBU)
model
```

We have a very slight positive correlation between ABV and IBU, with a coefficient of `r round(model$coefficients[[2]]*100,digits=4)` of increase % Alcohol per IBU point


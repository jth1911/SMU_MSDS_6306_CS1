---
title: "CaseStudy1"
author: "James Jarding, Nikhil Gupta, Max Moro"
date: "September 29, 2018"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DT)
library(tidyverse)
library(ggplot2)
library(htmltools)
library(knitr)
library(scales)

# For maps
library(maps)
library(geojsonio)
library(leaflet)
library(plotly)
```

```{r}
beers = read.csv('data/Beers.csv')
breweries = read.csv('data/Breweries.csv')

str(beers)
str(breweries)
```

# Question 1

How many breweries are present in each state?

```{r}
# Option 1
# breweriesState = breweries %>%
#   group_by(State) %>%
#   summarise(Breweries = n()) %>%
#   ungroup()

breweriesState = breweries %>% count(State) # Option 2
DT::datatable(breweriesState,rownames = F)
```

```{r Not Working Yet, eval=FALSE, include=FALSE}
# plot_usmap(data = breweriesState, values = "Breweries", lines = "red") +
#   scale_fill_continuous(name = "Breweries", label = scales::comma) +
#   theme(legend.position = "right")

```

```{r Leaflet Map}
str(breweriesState)

# https://rstudio.github.io/leaflet/map_widget.html
mapStates = map("state", fill = TRUE, plot = FALSE)
str(mapStates)
mapStates$names 
# This will not work becasue of the way states are defined; would need major rework
# example state names are "Arizona", but we have "AZ" in out dataframe. 
# Also, some states are named "michigan:north", "michigan:south", etc.

# Anyway adding some examples here in case we want to explore this further
leaflet(data = mapStates) %>% addTiles() %>%
  addPolygons(fillColor = topo.colors(10, alpha = NULL), stroke = FALSE)

m = leaflet() %>% addTiles()
df = data.frame(
  lat = rnorm(100),
  lng = rnorm(100),
  size = runif(100, 5, 20),
  color = sample(colors(), 100)
)
m = leaflet(df) %>% addTiles()
m %>% addCircleMarkers(radius = ~size, color = ~color, fill = FALSE)
m %>% addCircleMarkers(radius = runif(100, 4, 10), color = c('red'))

```

```{r Leaflet another option}
states <- geojsonio::geojson_read("http://eric.clst.org/assets/wiki/uploads/Stuff/gz_2010_us_outline_20m.json", what = "sp")
class(states)
names(states)
#head(states)

# Not sure yet if I need to get a special token for this.
# Below code is only plotting the boundary of US, not the states
# We can also try with other JSON files. They are available in the same link path as above.
m <- leaflet(states) %>%
  setView(-96, 37.8, 4) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) 

m %>% addPolygons()
```


```{r Plotly Map Example on Website not working}
# https://plot.ly/r/choropleth-maps/
df <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")
df$hover <- with(df, paste(state, '<br>', "Beef", beef, "Dairy", dairy, "<br>",
                           "Fruits", total.fruits, "Veggies", total.veggies,
                           "<br>", "Wheat", wheat, "Corn", corn))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

p <- plot_geo(df, locationmode = 'USA-states') %>%
  add_trace(
    z = ~total.exports, text = ~hover, locations = ~code,
    color = ~total.exports, colors = 'Purples'
  ) %>%
  colorbar(title = "Millions USD") %>%
  layout(
    title = '2011 US Agriculture Exports by State<br>(Hover for breakdown)',
    geo = g
  )
p

```




# Question 2

Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file

```{r}
data = merge(beers,breweries,by.x='Brewery_id',by.y='Brew_ID',all=T) 

h4('First 6 Observations')
DT::datatable(head(data,6),rownames = F)

h4('Last 6 Observations')
DT::datatable(tail(data,6),rownames = F)
```


# Question 3

Report the number of NA's in each column

```{r}
countNA = sapply(data,function(x){sum(is.na(x))})
kable(countNA,col.names='Count of NA')
```

# Question 4

Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare

```{r fig.height=7, warning=FALSE}

summary = data %>%
  group_by(State) %>%
  summarise(ABVMedian = median(ABV,na.rm=T)
            ,IBUMedian = median(IBU,na.rm=T)
            ) %>%
  ungroup() 

ggplot(data=filter(summary,!is.na(ABVMedian))
       ,aes(x=fct_reorder(State,ABVMedian,desc=T)
                        ,y=ABVMedian)) +
  geom_col() +
  xlab("State") +
  ylab("Median Alcohol Content") +
  scale_y_continuous(labels=percent)+
  coord_flip()

ggplot(data=filter(summary,!is.na(IBUMedian))
       ,aes(x=fct_reorder(State,IBUMedian,desc=T)
                        ,y=IBUMedian)) +
  geom_col() +
  xlab("State") +
  ylab("Median International Bitterness Unit") +
  coord_flip()

```


# Question 5

Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?

```{r}
message("The State with the maximum alcoholic (ABV) beer is:"
        ,arrange(data,desc(ABV))$State[1]
        )

message("The State with the most bitter (IBU) beer is:"
        ,arrange(data,desc(IBU))$State[1]
        )
```

# Question 6

Summary statistics for the ABV variable:

```{r}
summary(data$ABV)
```

# Question 7

Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.

```{r warning=FALSE}
ggplot(data=data,aes(x=IBU,y=ABV))+
  geom_point() +
  geom_smooth(method='lm') +
  scale_y_continuous(labels=percent)

model=lm(data=data,formula=ABV~IBU)
model
```

We have a very slight positive correlation between ABV and IBU, with a coefficient of `r round(model$coefficients[[2]]*100,digits=4)` of increase % Alcohol per IBU point

